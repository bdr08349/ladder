<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Extending Ladder - Ladder docs</title>
    <meta name="generator" content="Hugo 0.17" />

    
    <meta name="description" content="A flexible and reliable autoscaler">
    
    <link rel="canonical" href="https://themotion.github.io/ladder/operating/extending/">
    
    <meta name="author" content="TheMotion">
    

    <meta property="og:url" content="https://themotion.github.io/ladder/operating/extending/">
    <meta property="og:title" content="Ladder docs">
    <meta property="og:image" content="https://themotion.github.io/ladder/img/logo.png">
    <meta name="apple-mobile-web-app-title" content="Ladder docs">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://themotion.github.io/ladder/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://themotion.github.io/ladder/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://themotion.github.io/ladder/fonts/icon.eot?52m981');
        src: url('https://themotion.github.io/ladder/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
             url('https://themotion.github.io/ladder/fonts/icon.woff?52m981')
               format('woff'),
             url('https://themotion.github.io/ladder/fonts/icon.ttf?52m981')
               format('truetype'),
             url('https://themotion.github.io/ladder/fonts/icon.svg?52m981#icon')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://themotion.github.io/ladder/stylesheets/application.css">
    <link rel="stylesheet" href="https://themotion.github.io/ladder/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://themotion.github.io/ladder/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://themotion.github.io/ladder/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://themotion.github.io/ladder/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-deep-purple palette-accent-light-blue">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Extending Ladder
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/themotionvideo" title="@themotionvideo on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/themotion" title="@themotion on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/themotion/ladder" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://themotion.github.io/ladder/img/logo.png">
        </div>
      
      <div class="name">
        <strong>Ladder docs <span class="version">0.1.0</span></strong>
        
          <br>
          themotion/ladder
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/themotion/ladder/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/themotion/ladder/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    <span class="section">Introduction</span>
    <ul>
      
        
        



<a  title="Overview" href="https://themotion.github.io/ladder/introduction/overview/">
	
	Overview
</a>



      
        
        



<a  title="Installing" href="https://themotion.github.io/ladder/introduction/installing/">
	
	Installing
</a>



      
        
        



<a  title="Quickstart" href="https://themotion.github.io/ladder/introduction/quickstart/">
	
	Quickstart
</a>



      
    </ul>
  
</li>



<li>
  
    <span class="section">Concepts</span>
    <ul>
      
        
        



<a  title="Autoscaler" href="https://themotion.github.io/ladder/concepts/autoscaler/">
	
	Autoscaler
</a>



      
        
        



<a  title="Blocks" href="https://themotion.github.io/ladder/concepts/blocks/">
	
	Blocks
</a>



      
    </ul>
  
</li>



<li>
  
    <span class="section">Available Blocks</span>
    <ul>
      
        
        



<a  title="Gatherers" href="https://themotion.github.io/ladder/blocks/gatherers/">
	
	Gatherers
</a>



      
        
        



<a  title="Arrangers" href="https://themotion.github.io/ladder/blocks/arrangers/">
	
	Arrangers
</a>



      
        
        



<a  title="Solvers" href="https://themotion.github.io/ladder/blocks/solvers/">
	
	Solvers
</a>



      
        
        



<a  title="Filters" href="https://themotion.github.io/ladder/blocks/filters/">
	
	Filters
</a>



      
        
        



<a  title="Scalers" href="https://themotion.github.io/ladder/blocks/scalers/">
	
	Scalers
</a>



      
    </ul>
  
</li>



<li>
  
    <span class="section">Operating</span>
    <ul>
      
        
        



<a  title="Running" href="https://themotion.github.io/ladder/operating/running/">
	
	Running
</a>



      
        
        



<a  title="Configuration" href="https://themotion.github.io/ladder/operating/configuration/">
	
	Configuration
</a>



      
        
        



<a  title="Metrics" href="https://themotion.github.io/ladder/operating/metrics/">
	
	Metrics
</a>



      
        
        



<a  title="API" href="https://themotion.github.io/ladder/operating/api/">
	
	API
</a>



      
        
        



<a  title="Extending Ladder" href="https://themotion.github.io/ladder/operating/extending/">
	
	Extending Ladder
</a>



      
    </ul>
  
</li>



<li>
  
    <span class="section">Community</span>
    <ul>
      
        
        



<a  title="Communication channels" href="https://themotion.github.io/ladder/community/mailing-list/">
	
	Communication channels
</a>



      
    </ul>
  
</li>



<li>
  
    



<a  title="License" href="https://github.com/themotion/ladder/blob/master/LICENSE">
	
	License
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/themotionvideo" target="_blank" title="@themotionvideo on Twitter">
              @themotionvideo on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/themotion" target="_blank" title="@themotion on GitHub">
              @themotion on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:tech-honey-badger@themotion.com" title="Email of tech-honey-badger@themotion.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Extending Ladder </h1>

			

<p>Sometimes we want to scale our custom targets, or apply custom logic on filters or arrengers,
or our company uses a very strange metric system where all our metrics are, in order you can
solve this <em>problems</em> Ladder lets you extend using <a href="https://golang.org/pkg/plugin">Go plugins</a>.</p>

<p>Extending Ladder to add custom logic is very easy!, as was described in the [blocks] section, Ladder
is made up of 5 type of blocks: gatherers, arrangers, solvers, filters and scalers. You can create any
custom kind of this blocks but it has some requirements.</p>

<h2 id="requirements">Requirements</h2>

<ul>
<li>You need to compile your plugin against the Ladder version that you want to use</li>
<li>It will use Go &gt;=1.8</li>
<li>Requires to autoregister the plugin (See the example)</li>
</ul>

<h2 id="blocks">Blocks</h2>

<p>Depending on each block we want to implement you will need to satisfy specific interfaces. Lets start</p>

<h3 id="gatherer">Gatherer</h3>

<pre><code class="language-golang">type Gatherer interface {
	Gather(ctx context.Context) (types.Quantity, error)
}
</code></pre>

<ul>
<li><code>Gather</code> method receives a context an returns a quantity and an error, this method should get the
metrics from the external source and return them</li>
</ul>

<h3 id="arranger">Arranger</h3>

<pre><code class="language-golang">type Arranger interface {
	Arrange(ctx context.Context, inputQ, currentQ types.Quantity) (newQ types.Quantity, err error)
}
</code></pre>

<ul>
<li><code>Arrange</code> method receives a context and 2 quantities, the first quantity is the value obtained from the
gatherer and the second one is the current scaling target quantity, it should return the wanted
quantity to set up on the scaling target (finters and solvers may change this quantity before reaching the scaler) and an error if required</li>
</ul>

<h3 id="solver">Solver</h3>

<pre><code class="language-golang">type Solver interface {
	Solve(ctx context.Context, qs []types.Quantity) (types.Quantity, error)
}
</code></pre>

<ul>
<li><code>Solve</code> methods receives a context and an slice of quantities, this values will be all the quantities
got from all the inputters (gatherer + arranger) it should return one, and an error if required</li>
</ul>

<h3 id="filter">Filter</h3>

<pre><code class="language-golang">type Filterer interface {
	Filter(ctx context.Context, currentQ, newQ types.Quantity) (q types.Quantity, br bool, err error)
}
</code></pre>

<ul>
<li><code>Filter</code> method receives a context and 2 quantities, the first one is the currenr scalign target quantity
and the second one is the new quantity (from the solver or previous filter). It returns a quantity
a boolean that if tru it will break teh chain and an error.</li>
</ul>

<h3 id="scaler">Scaler</h3>

<pre><code class="language-golang">type Scaler interface {
	Current(ctx context.Context) (types.Quantity, error)
	Scale(ctx context.Context, newQ types.Quantity) (scaledQ types.Quantity, mode types.ScalingMode, err error)
	Wait(ctx context.Context, scaledQ types.Quantity, mode types.ScalingMode) error
}
</code></pre>

<ul>
<li><code>Current</code> method receives a context and returns a quantity that should be the current quantity an scaling target has, and an error if required</li>
<li><code>Scale</code> receives the context and the scaling quantity decided, it should scale the scaling target and return the quantity scalated to, the scaling mode (ScalingUp, ScalingDown, NotScaling) and an error if required</li>
<li><code>Wait</code> method receives a context, the scaled quantity and the mode of the scalation, it should wait
until you decide when the scalation process is finished, returns an error if required</li>
</ul>

<h2 id="example">Example</h2>

<p>We will make a simple filter as an example. This filter will be called <code>chaos</code> and will apply some sort
of chaos monkey of scalation process. The filter will stop the chain and not scale (return the current quantity as the new quantity) 50% of the times.</p>

<p>file <code>chaos.go</code>:</p>

<pre><code class="language-golang">package main

import (
	&quot;context&quot;
	&quot;math/rand&quot;
	&quot;time&quot;

	&quot;github.com/themotion/ladder/autoscaler/filter&quot;
	&quot;github.com/themotion/ladder/log&quot;
	&quot;github.com/themotion/ladder/types&quot;
)

const (
	chaosRegName = &quot;chaos&quot;
)

func init() {
	filter.Register(chaosRegName, filter.CreatorFunc(func(ctx context.Context, opts map[string]interface{}) (filter.Filterer, error) {
		return NewChaos(ctx, opts)
	}))
}

// Chaos will drop randomly any scalup or scaledown
type Chaos struct {
	ctx context.Context
	log *log.Log // custom logger
}

// NewChaos returns a new chaos filter
func NewChaos(ctx context.Context, _ map[string]interface{}) (*Chaos, error) {
	asName, ok := ctx.Value(&quot;autoscaler&quot;).(string)
	if !ok {
		asName = &quot;unknown&quot;
	}
	logger := log.WithFields(log.Fields{
		&quot;autoscaler&quot;: asName,
		&quot;kind&quot;:       &quot;filterer&quot;,
		&quot;name&quot;:       chaosRegName,
	})

	return &amp;Chaos{
		ctx: ctx,
		log: logger,
	}, nil
}

// Filter will drop randomly scaling stuff and break the chain
func (c Chaos) Filter(ctx context.Context, currentQ, newQ types.Quantity) (types.Quantity, bool, error) {
	var brk bool
	r := rand.New(rand.NewSource(time.Now().UnixNano()))
	if r.Intn(100)%2 == 0 {
		newQ = currentQ
		brk = true
		c.log.Warningf(&quot;Chaos applied!, breaking the chain and setting to current&quot;)
	}
	return newQ, brk, nil
}
</code></pre>

<p>We start from top to down:</p>

<p><code>init</code> function executes automatically when the plugin is laoded, in this function we register our filter
using ladder filter register helper <code>filter.Register</code> with the filter name <code>chaos</code>, we register a <code>filter.CreatorFunc</code> that is a function
wrapping the creation of our filter object.</p>

<p><code>NewChaos</code> creates the filter instance, it receives the context, from there we get the autoscaling name to
set up correctly on the logger, and it receives the <code>config</code> map that we define on the settings, in this
case, this filter doesn&rsquo;t have any options so, we ignore this parameter.</p>

<p>At last <code>Filter</code> will apply chaos when a random number is multiple of 2 (50%).</p>

<p>We need to compile the plugin against the version of Ladder that will run so we get that Ladder version and
do <code>go build -buildmode=plugin -o {DST_PATH}/chaos.so ./chaos.go</code> and we only need to set up on our <code>ladder.cfg</code> file to load that shared lib (.so). Example:</p>

<pre><code class="language-yaml">global:
  warmup: 10s
  plugins:
    - myplugins/chaos.so

autoscaler_files:
  - &quot;cfg-autoscalers/*.yml&quot;
</code></pre>

<p>and use it on the autoscalers:</p>

<pre><code class="language-yaml">...
  filters:
    - kind: chaos
...
</code></pre>

<p>Check a full ladder plugin project as a further example <a href="https://github.com/slok/ladder-plugin-example">here</a></p>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Plugins file names (f.e <code>myplugin.go</code>) can&rsquo;t be the same, See <a href="https://github.com/golang/go/issues/19004">Go issue</a></p>
</div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ladder plugins should be compiled against the same libc used to compile Ladder. for example
if you use Ladder on themotion docker image (it uses alpine with musl-libc, your plugin should be compiled against musl libc instead of glibc</p>
</div>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the BSD 3-clause &#39;New&#39; or &#39;Revised&#39; license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://themotion.github.io/ladder/operating/api/" title="API">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              API
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://themotion.github.io/ladder/operating/metrics/" title="Metrics">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Metrics
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/themotion.github.io\/ladder\/';
      var repo_id  = 'themotion\/ladder';
    
    </script>

    <script src="https://themotion.github.io/ladder/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;
            
            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }
        

        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//gohugo.io/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
